# ğŸµ OpenClaw Avatar - Docker é•œåƒ
# ç”¨äº Web ç‰ˆæœ¬éƒ¨ç½²

# ============================================
# Stage 1: æ„å»º
# ============================================
FROM node:22-alpine AS builder

# å®‰è£… pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/desktop/package.json ./apps/desktop/

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY apps/desktop/ ./apps/desktop/

# æ„å»º (ä»… Web ç‰ˆæœ¬ï¼Œä¸å« Tauri)
WORKDIR /app/apps/desktop
RUN pnpm build

# ============================================
# Stage 2: è¿è¡Œ
# ============================================
FROM nginx:alpine AS runner

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/apps/desktop/dist /usr/share/nginx/html

# å¤åˆ¶ nginx é…ç½®
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost/ || exit 1

# å¯åŠ¨
CMD ["nginx", "-g", "daemon off;"]
